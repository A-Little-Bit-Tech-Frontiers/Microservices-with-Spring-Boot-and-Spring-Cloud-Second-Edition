# 스프링 부트를 사용한 마이크로서비스 개발

## 독립 소프트웨어 컴포넌트

<img width="676" alt="스크린샷 2024-09-19 오후 8 02 03" src="https://github.com/user-attachments/assets/d2ee2cd6-00b0-470a-baa0-e53fa601dfd6">

- 장점
  - 플랫폼의 각 컴포넌트는 개별적으로 배포, 업그레이드할 수 있다.
  - 명확한 API를 사용하면 플랫폼의 각 컴포넌트를 다른 컴포넌트와 상관없이 여러 서버로 스케일 아웃 가능하다.
- 단점
  - 컴포넌트의 새 인스턴스를 추가하려면 수동으로 LB를 구성하고, 새 노드를 수동으로 설정해야 한다.
  - 통신하는 다른 시스템에서 오류가 발생했을 때 플랫픔으로 퍼진다.
  - 플랫폼에서 보낸 요청에 다른 시스템이 제 시간에 응답하지 않으면, 많은 요청이 들어왔을때 운영체제 스레드 등의 주요 자원이 부족해진다.
  - 모든 컴포넌트 인스턴스의 구성을 일관되게 최신 상태로 유지하기 어렵다.
  - 플랫폼 상태를 모니터링하는 일은 일체형 애플리케이션의 인스턴스 하나를 모니터링하는 것보다 복잡하다.
  - 분산된 여러 컴포넌트에서 로그 파일을 수집하고 관련된 컴포넌트 로그 이벤트를 상호 연관시키는것도 어렵다.

## 마이크로서비스 입문

많은 선구자가 일체형 애플리케이션을 독립적으로 출시 및 스케일링할 수 있는 작은 컴포넌트로 나누는 방식으로 전환하기 시작했다. <br>
앞단에 LB를 두고 여러 개의 소형 서버에 작은 컴포넌트를 배포하면 수평 스케일링이 가능하다. <br>
클라우드에 배포하는 경우 가상 서버를 필요한 만큼 계속해서 추가하면 되기 때문에, 거의 무한대로 확장 가능하다.

## 마이크로서비스 정의

- 빠르게 개발해 지속적으로 배포할 수 있어야 한다.
- 수동/자동으로 쉽게 스케일링할 수 있어야 한다.
- 데이터베이스의 데이터를 공유하지 않는다.
- 명확한 인터페이스를 통해서만 통신해야 한다.
- 각 마이크로서비스 인스턴스를 도커 컨테이너와 같이 독립된 런타임 프로세스로 실행해야 한다.
- 마이크로서비스 인스턴스는 상태가 없다. 따라서 모든 마이크로서비스 인스턴스가 마이크로서비스로 들어오는 요청을 처리할 수 있다.

## 마이크로서비스의 문제

- 동기식 통신을 사용하는 다수의 소형 컴포넌트는 연쇄 장애를 일으킬 수 있다.
- 많은 컴포넌트가 처리에 관여하는 요청은 추적하기 어렵다.
- 컴포넌트 수준의 하드웨어 자원 사용량 분석도 어렵다.

## 마이크로서비스 디자인 패턴

### 서비스 검색

클라이언트가 마이크로서비스와 그 인스턴스를 찾을 수 있어야 한다. <br>
컨테이너에서 실행되는 마이크로서비스 인스턴스는 시작하면서 동적 IP 주소를 할당받는데, 이런 상황은 HTTP REST API를 호출하기 어렵게 한다. <br>
이를 해결하기 위한 필요 조건은 다음과 같다.

- 마이크로서비스와 마이크로서비스 인스턴스를 자동으로 등록/해지한다.
- 클라이언트는 마이크로서비스의 논리 엔드포인트에 요청을 보낼 수 있어야 한다. 요청은 가용 마이크로서비스 인스턴스 중 하나로 라우팅된다.
- 마이크로서비스에 대한 요청은 가용 인스턴스로 로드밸런싱돼야 한다.
- 상태가 비정상인 인스턴스를 감지해 요청을 라우팅하지 말아야 한다.

### 에지 서버

마이크로서비스 시스템 환경에서는, 일부 마이크로서비스만 시스템 환경 외부에 공개하고 그 외는 외부에서 접근하지 못하도록 숨겨야 한다. <br>
공개된 마이크로서비스는 악의적인 클라이언트의 요청으로부터 보호해야 한다. <br>
이에 대한 해결책은 모든 요청이 거치는 시스템 환경에 에지 서버를 추가하는 것이다. <br>
일반적으로 에지 서버는 리버스 프록시로 동작하며, 동적 로드밸런싱 기능을 제공하고자 검색 서비스와 통합될 수 있다.

<img width="565" alt="스크린샷 2024-09-19 오후 8 17 08" src="https://github.com/user-attachments/assets/47fdf484-d440-4b16-94f7-8729f17dfffc">

### 구성 중앙화

구성 중앙화는 실행중인 모든 마이크로서비스 인스턴스의 구성 정보를 한눈에 볼 수 있고, 구성을 업데이트하고 관련된 모든 마이크로서비스 인스턴스가 올바르게 업데이트 되게 한다.

<img width="579" alt="스크린샷 2024-09-19 오후 8 19 48" src="https://github.com/user-attachments/assets/a9cde7fc-6a51-42f9-b70f-bc16d6143890">

### 로그 분석 중앙화

마이크로서비스는 로그 이벤트에 상관 ID를 삽입한다. <br>
표준 로그 형식을 정의하면 로그 이벤트를 중앙 데이터베이스에 저장하기 전에 로그 수집기가 마이크로서비스에서 수집한 로그 이벤트를 표준 로그 형식으로 변환할 수 있다.

### 분산 추적

시스템 환경에 대한 외부 요청을 처리하는동안 마이크로서비스 사이에 흐르는 요청 및 메시지를 추적할 수 있어야 한다. <br>
관련된 모든 요청 및 메시지에 상관 ID를 넣어야 하고, 모든 로그 이벤트에 상관 ID가 있어야 한다. <br>
상관 ID는 헤더와 같이 찾기 쉬운곳에 넣고, 외부로 요청이나 메시지를 보낼때 꼭 넣는다.

### 서킷 브레이커

동기 방식으로 통신하는 마이크로서비스 시스템에서는 연쇄 장애가 발생할 수 있다. <br>
이를 해결하기 위해 대상 서비스에 문제가 있다는것을 감지해 새 요청을 보내지 않도록 차단하는 서킷브레이커를 추가한다. <br>
서비스에 문제가 감지되면 timeout을 무시하고 서킷을 연다.












