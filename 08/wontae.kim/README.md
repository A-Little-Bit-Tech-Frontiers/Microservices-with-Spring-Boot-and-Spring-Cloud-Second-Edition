# 8장 스프링 클라우드 소개

---

### 스프링 클라우드 핵심 마이크로서비스 프레임워크

- **스프링 클라우드 넷플릭스 유레카 [서비스 검색]**
    - 마이크로서비스 등록
    - 검색 서비스를 이용해 로드 밸런싱이 가능하다.
- **스프링 클라우드 컨피그 [마이크로서비스 구성 관리]**
    - 각 마이크로 서비스는 컨피그 서버에 구성을 요청한다.
    - 컨피그 서버는 구성 변경시 각 마이크로서비스에 변경 알림을 줄 수 있다.
    - Git Hook 에 대해서 컨피그 서버에 알림을 줄 수 있다.
    
    ```mermaid
    flowchart
    	m1[마이크로서비스 1]
    	m2[마이크로서비스 2]
    	m3[마이크로서비스 3]
    	m4[마이크로서비스 4]
    	cs(((컨피그 서버)))
    	m1--구성 조회-->cs
    	m2--구성 조회-->cs
    	m3--구성 조회-->cs
    	m4--구성 조회-->cs
    	t[[구성 변경 토픽]]
    	cs--변경 감지 알림-->t
    	t-->m1
    	t-->m2
    	t-->m3
    	t-->m4
    	g(Git Storage)
    	cs--구성 조회-->g
    	g--변경 알림-->cs
    ```
    
- **스프링 클라우드 게이트웨이 [에지 서버]**
    - URL 경로 기반 라우팅, OAuth 2.0, OIDC(OpenID Connect) 기반 엔드포인트 보호 등의 기능 지원
    - 넷플릭스 Zuul v1 에 비해 논블로킹 API 사용하여 많은 요청을 처리할 수 있다.
- **Resilience4j [서킷 브레이커]**
    - 넓은 범위의 내결함성 매커니즘 제공
    - 서킷 브레이커 - 원격 서비스가 응답하지 않으면 연쇄 장애 방지
    - 비율 제한기 - 지정 시간 동안 서비스 요청 수 제한
    - 격벽(bulkhead) - 서비스 동시 요청 수 제한
    - 재시도 - 가끔 발생하는 임의의 오류 처리
    - 시간 제한기 - 장시간 느리거나 응답이 없는 서비스는 기다리지 않도록 한다.
    
    ```mermaid
    flowchart
    	s((1. 시작))
    	c[[닫힘]]
    	o[[열림]]
    	ho[[반열림]]
    	
    	s-->c
    	c--2. 성공-->c
    	c--3. 실패-->c
    	c--4. 트립(실패 임계값 도달)-->o
    	o--5. 빠른 실패-->o
    	o--6. 닫기 시도-->ho
    	ho--7. 트립(실패)-->o
    	ho--8. 닫힘(성공)-->c
    	
    	
    ```
    
- **스프링 클라우드 슬루스 & 집킨 [분산 추적]**
    - 마이크로시스템과 같은 분산 시스템의 상황 파악을 위해서 외부 요청 처리 과정에서 서비스 간에 발생하는 요청 및 메시지의 흐름을 추적 및 시각화
    - **슬루스**에서는 상관 ID (Trace ID) 를 사용해 요청 및 메시지, 이벤트에 표식을 남긴다. 또한 각 마이크로서비스의 로그 레코드에도 상관 ID 를 붙인다.
    - **슬루스**는 추적 데이터를 저장, 시각화하기 위해 **집킨**으로 전송한다.
    - 전체 워크플로의 추적 정보는 **Trace Tree** 라고 하고, 트리의 하위 집합은 **Span** 라고 한다. 각각의 TraceId, SpanId 를 사용해 Span 을 식별한다.
    
    ```mermaid
    flowchart
    	ms1[마이크로서비스1]
    	ms2[마이크로서비스2]
    	ms3[마이크로서비스3]
    	ms1--추적 ID 1-->ms2
    	ms1--추적 ID 2-->ms3
    	ms2--추적 ID 1-->ms3
    	zt[[Zipkin Topic]]
    	z[Zipkin]
    	ms2-->zt
    	ms3-->zt
    	zt-->z
    	z-->db[[추적 ID 데이터베이스]]
    ```