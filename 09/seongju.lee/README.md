# 서비스 검색 

## Eureka를 이용한 서비스 검색


### DNS 기반 서비스 검색의 문제

새 마이크로서비스 인스턴스를 시작한 다음 라운드 로빈 방식의 DNS를 이용하면 안될까?

라운드 로빈 DNS의 기본 개념은 각 마이크로서비스 인스턴스가 같은 이름으로 DNS 서버에 IP 주소를 등록하는 것이다. 클라이언트 DNS 이름에 대한 IP 주소를 요청하면 DNS 서버는 등록된 인스턴스 IP 주소를 반환한다. 클라이언트는 이 주소 목록을 사용해 라운드 로빈 방식으로 차례대로 인스턴스에 요청을 보내게 된다.

하지만, 마이크로서비스 인스턴스들 중 하나에서만 응답을 받을 가능성이 높다.

**DNS 클라이언트**는 DNS 서버에 DNS 이름 확인을 요청하고 IP 주소 목록을 받는다. 
그런 다음 **작동하는 IP 주소를 찾을 때까지 IP 주소 목록에 있는 IP 주소로 접속을 시도하며 대부분 첫 번째 주소로 연결**되는 경우가 많다. 
**DNS 클라이언트는 일반적으로 사용 중인 IP 주소를 계속 사용하며 요청할 때마다 라운드 로빈 방식을 적용하지는 않는다.** 
또한 일반적인 DNS 서버 및 DNS 프로토콜은 수시로 생성 및 종료되는 마이크로서비스 인스턴스를 처리하는 데에는 적합하지 않다.


### 서비스 검색의 문제

다음 상황을 고려해 마이크로서비스 인스턴스를 추적해야 한다.

- 언제든지 새로운 인스턴스가 시작될 수 있다.
- 언제든지 기존 인스턴스가 응답하지 않을 수 있으며, 결국에는 중단될 수 있다.
- 실패한 인스턴스 중 일부는 얼마 후에 정상 상태로 돌아와서 다시 트래픽을 수신하지만 그렇지 못하는 인스턴스도 있다. 실패에서 복구되지 못한 인스턴스는 서비스 레지스트리에서 제거해야 한다.
- 일부 마이크로서비스 인스턴스는 시작하는 데 시간이 걸릴 수 있다. 즉, HTTP 요청을 수신한다고 해서 즉시 라우팅할 수 있는 것은 아니다.
- 언제든지 의도하지 않은 네트워크 파티셔닝과 그 밖의 네트워크 관련 오류가 발생할 수 있다.


### Eureka를 이용한 서비스 검색

<img width="522" alt="image" src="https://github.com/user-attachments/assets/5aab39ae-f733-485a-883f-ef17281d1baa">

유레카는 클라이언트 측 서비스 검색을 구현한다. 즉, 클라이언트는 사용 가능한 마이크로서비스 인스턴스 정보를 얻고자 소프트웨어를 실행해 검색 서버인 유레카와 통신한다.

1. Review 서비스 등의 마이크로서비스 인스턴스는 시작할 때마다 자신을 유레카 서버에 등록한다.
2. 각 마이크로서비스 인스턴스는 유레카 서버에 주기적으로 하트비트 메시지를 보낸다.
3. Product-Composite와 같은 클라이언트는 클라이언트 라이브러리를 사용해, 사용 가능한 서비스의 정보를 정기적으로 유레카 서비스에 요청한다.
4. 클라이언트에서 다른 마이크로서비스로 요청을 보내야 하는 경우에는 클라이언트 라이브러리에 보존된 사용 가능한 인스턴스 목록에서 대상을 선택할 수 있으며, 라운드 로빈 방식으로 인스턴스를 선택한다.

스프링 클라우드는 유레카 등의 검색 서비스와 통신하는 방법을 추상화 한, DiscoverClient라는 인터페이스를 제공한다.
DiscoverClient를 사용하면 검색 서비스와 연계해 사용 가능한 서비스 및 인스턴스에 관한 정보를 얻을 수 있다.

이와 같이 유레카는 런타임 특성으로 내결함성, 견고성, 복원력을 가진 매우 뛰어난 서비스 검색 서버다.  
